@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<ul class="navbar-nav flex-grow-1">
    <li class="nav-item">
    </li>
    <li class="nav-item">
        <button class="Errorbutton" id="errorsButton" data-toggle="modal" data-target="#errorsModal" title="Ошибки контроллера"></button>
    </li>
</ul>

<!-- Modal -->
<div class="modal fade" id="errorsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Ошибки контроллера</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @*<table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Код</th>
                            <th>Описание</th>
                        </tr>
                    </thead>*@
                    
                        <div id="errorsContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="sumbitButton">Сбросить ошибки</button>
            </div>
        </div>
    </div>
</div>

<script src="~/js/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var timerId = setTimeout(function tick() { //рекурсивный setTimeout вызов более точный чем setInterval
            getOnlineData();
            timerId = setTimeout(tick, timeUpdateInterval);
        }, timeUpdateInterval);

        $('#errorsModal').appendTo("body");
        $('[data-toggle="tooltip"]').tooltip();

        $("#errorsButton").click(function () { //вывести на экран список ошибок
            if (errorsList != null) {
                $('#errorsContainer').empty();
                var table = $('<table class="table table-striped"></table>').addClass('foo');
                var row = $('<tr></tr>');
                var col1 = $('<th>Код</th>');
                var col2 = $('<th>Описание</th>');
                table.append(row);
                row.append(col1);
                row.append(col2);
                $.each(errorsList, function (index, value) {
                    var row = $('<tr></tr>');
                    var col1 = $('<td></td>').addClass('bar').text(index);
                    var col2 = $('<td></td>').addClass('bar').text(value);
                    table.append(row);
                    row.append(col1);
                    row.append(col2);
                });
                $('#errorsContainer').append(table);
            }
        });
        $("#sumbitButton").click(function () { //сбросить ошибки
            setResetErrors();
        });
    });

    var timeUpdateInterval = 500;
    var errorsList = null;

    function setResetErrors() {
            $.ajax({
                method: "GET",
                url: "@Url.Action("SetResetErrors", "Home")?random=" + Math.random(),
                //data: { jackUp: jackUp, jackDown: jackDown, cargoLeft: cargoLeft, cargoRight: cargoRight, speedJack: speedJack, speedCargo: speedCargo},
                dataType: "json",
                success: function (result) {
                },
                error: function (result) {
                }
            });
        }

    function getOnlineData() {
        $.ajax({
            type: "GET",
            url: "@Url.Action("GetControllerDataRepeat", "Home")?random=" + Math.random(),
            dataType: "json",
            success: function (result) {

                //console.log(result);

                if (result.connectDevice == 1) {
                   $("#connectLamp").css("background-color", "green");
                }
                else {
                    $("#connectLamp").css("background-color", "red");
                }
                if (Object.keys(result.errorsList).length == 0) {
                    $("#errorsButton").css("background-color", "green");
                }
                else {
                    $("#errorsButton").css("background-color", "red");
                }
                $("#errorsButton").text(Object.keys(result.errorsList).length.toString());
                errorsList = result.errorsList;
            }
        });
    }

</script>
